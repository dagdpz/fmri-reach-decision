function frd_pipeline2_automized
% wrapper function for First Level Analysis and AVG creation PER SESSION using NeuroElf.

% This function is specific to the fmri_reach_decision project.

%%
clear all

load('Y:\MRI\Human\fMRI-reach-decision\Experiment\behavioral_data\protocols_v2.mat');

runpath = 'Y:\MRI\Human\fMRI-reach-decision\Experiment\MNI';

for_GLM = 1; % 0
for_AVG = 1; % 0

%%
save('Y:\MRI\Human\fMRI-reach-decision\Experiment\buffer_for_pipeline.mat','prot', 'runpath','for_GLM','for_AVG')  % has to be hard coded, see below as well

for i = 1:length(prot)
    
    sessions = length(prot(i).session);
    
    for k = 1:sessions
        
        if for_GLM
            % incl. outl preds.
            % for GLM
            ne_pl_process_one_session_3TUMG_part2(...
                [runpath filesep prot(i).name filesep prot(i).session(k).date],...
                [prot(i).name '_' prot(i).session(k).date],...
                'Human_reach_decision',...
                {'create_mdm','create_glm'},...
                'model',...
                    'mat2prt_reach_decision_vardelay_forglm',...
                'prt2avg_script',...
                    'ne_prt2avg_reach_decision_vardelay_forglm',...
                'vtc_pattern',...
                    '*_tf.vtc',...
                'sdm_pattern',...
                    '*_outlier_preds.sdm');  %  '*_MCparams.sdm'); % change here for incl outlier predictors or not
        end
        
        if for_AVG
            % incl. outl preds.
            % for AVG
            ne_pl_process_one_session_3TUMG_part2(...
                [runpath filesep prot(i).name filesep prot(i).session(k).date],...
                [prot(i).name '_' prot(i).session(k).date],...
                'Human_reach_decision',...
                {'create_avg','exclude_outliers_avg'},...
                'model',...
                    'mat2prt_reach_decision_vardelay_foravg',...
                'prt2avg_script',...
                    'ne_prt2avg_reach_decision_vardelay_foravg',...
                'vtc_pattern',...
                    '*_tf.vtc');
        end
        
        save('Y:\MRI\Human\fMRI-reach-decision\Experiment\buffer_for_pipeline.mat','prot', 'runpath','i','k','for_GLM','for_AVG')
        %memory
        %inmem
        
        clear all
        
        load('Y:\MRI\Human\fMRI-reach-decision\Experiment\buffer_for_pipeline.mat')
        %memory
        %inmem
        
    end
end

